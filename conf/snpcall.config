/*
* -------------------------------------------------
* SNPcall Nextflow config file
* -------------------------------------------------
* This file contains basic process requirement setup
* It DOES NOT contain any config for cluster, so will run
* in default mode by itself. It should be used with
* the max_memory, max_cpus and max_time params for
* customising hardware limits
*/

singularity {
    enabled = true
    cacheDir = "$HOME/.singularity"
}

process {

  errorStrategy = { task.exitStatus in [143,137] ? 'retry' : 'terminate' }
  maxRetries = 3
  maxErrors = '-1'

  /*
  conda.cacheDir = "$HOME/.conda/envs"
  beforeScript = 'module load Anaconda3/5.3.0'
  conda{
    process.conda = "$baseDir/environment.yml"
  }
  */
  container = 'nordborglab/snpcall:latest'

  withLabel: env_small {
    cpus = { check_max( 1 * task.attempt, 'cpus') }
    memory = { check_max( 15.GB * task.attempt, 'memory') }
    time = { check_max( 6.h * task.attempt, 'time') }
    errorStrategy = { task.exitStatus in [143,137] ? 'retry' : 'ignore' }
  }

  withLabel: env_medium {
    cpus = { check_max( 2 * task.attempt, 'cpus') }
    memory = { check_max( 20.GB * task.attempt, 'memory') }
    time = { check_max( 10.h * task.attempt, 'time') }
  }

  withLabel: env_large {
    cpus = { check_max( 8 * task.attempt, 'cpus') }
    memory = { check_max( 70.GB * task.attempt, 'memory') }
    time = { check_max( 10.h * task.attempt, 'time') }
  }

}
