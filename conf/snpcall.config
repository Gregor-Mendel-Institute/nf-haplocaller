/*
* -------------------------------------------------
* SNPcall Nextflow config file
* -------------------------------------------------
* This file contains basic process requirement setup
* It DOES NOT contain any config for cluster, so will run
* in default mode by itself. It should be used with
* the max_memory, max_cpus and max_time params for
* customising hardware limits
*/


process {

  cpus = { check_max( 1 * task.attempt, 'cpus') }
  memory = { check_max( 15.GB * task.attempt, 'memory') }
  time = { check_max( 6.h * task.attempt, 'time') }

  errorStrategy = { task.exitStatus in [143,137] ? 'retry' : 'terminate' }
  maxRetries = 3
  maxErrors = '-1'

  $makeBWAindex {
    module = ['BWA/0.7.15-foss-2016a', 'SAMtools/1.3.1-foss-2016a', 'picard/2.6.0-Java-1.8.0_131']
  }

  $extractFastq {
    module = ['picard/2.6.0-Java-1.8.0_131', 'sratoolkit/2.8.1-3']
  }

  $fastqc {
    module = ['FastQC/0.11.5-foss-2016a']
    errorStrategy = { task.exitStatus in [143,137] ? 'retry' : 'ignore' }
  }

  $trim_galore {
    module = ['Trim_Galore/0.4.1-foss-2016a']
    cpus = { check_max( 2 * task.attempt, 'cpus') }
    memory = { check_max( 20.GB * task.attempt, 'memory') }
    time = { check_max( 8.h * task.attempt, 'time') }
  }

  $alignReads {
    module = ['BWA/0.7.15-foss-2016a']
    cpus = { check_max( 8 * task.attempt, 'cpus') }
    memory = { check_max( 80.GB * task.attempt, 'memory') }
    time = { check_max( 16.h * task.attempt, 'time') }
  }

  $processBam {
    module = ['SAMtools/1.3.1-intel-2016a']
    cpus = { check_max( 2 * task.attempt, 'cpus') }
    memory = { check_max( 20.GB * task.attempt, 'memory') }
    time = { check_max( 16.h * task.attempt, 'time') }
  }

  $picardBam {
    module = ['SAMtools/1.3.1-intel-2016a', 'picard/2.6.0-Java-1.8.0_131']
  }

  $realignBam {
    module = ['GATK/3.5-Java-1.8.0_45', 'SAMtools/1.3.1-intel-2016a']
  }

  $doSNPcall {
    module = ['GATK/3.5-Java-1.8.0_45']
    cpus = { check_max( 4 * task.attempt, 'cpus') }
    memory = { check_max( 40.GB * task.attempt, 'memory') }
    time = { check_max( 16.h * task.attempt, 'time') }
  }

  $joinGVCFs {
    module = ['GATK/3.5-Java-1.8.0_45']
    cpus = { check_max( 8 * task.attempt, 'cpus') }
    memory = { check_max( 100.GB * task.attempt, 'memory') }
    time = { check_max( 16.h * task.attempt, 'time') }
  }

  $getSamples {
    module = ['tabix/0.2.6-goolf-1.4.10']
  }

  $selectSNPs {
    module = ['GATK/3.5-Java-1.8.0_45']
  }

}
